<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Hentai</title>
	<link rel="stylesheet" type="text/css" href="page.css?v=2">
	<script src="//code.jquery.com/jquery-1.11.0.min.js"></script>
	<script src="//code.jquery.com/jquery-migrate-1.2.1.min.js"></script>
	<script>

  		var page=0,listbookimglink,bookpage=0;

		$(function(){
			$('.page2 , #loading').hide();
			
			showlist();

			$('#btn_get').click(function(event) {
				showlist();
			});

			$('#keyword').keypress(function( event ) {
			   if ( event.which == 13 ) showlist();
			});
					

			$('.page2').scroll(function(event) {
				event.stopPropagation();
			});

			$('#bookcolose').click(function(event) {
				$('.page2').fadeOut('fast');
			});

			$('#bookbackend').click(function(event) {
				bookpage=0;
				getdetailImg(bookpage);
			});
			$('#bookprev').click(function(event) {
				if(bookpage>0){
					bookpage--;
					getdetailImg(bookpage);
				}
			});
			$('#booknext').click(function(event) {
				if(bookpage<listbookimglink.length){
					bookpage++;
					getdetailImg(bookpage);
				}
			});
			$('#bookend').click(function(event) {
				bookpage=listbookimglink.length-1;
				getdetailImg(bookpage);
			});


			function showlist(){
				var keyword = $('#keyword').val(),
					loading = $('<img>').attr('src', 'img/loading.gif');

				$('.page').html("").append(loading);
			
				var sp_kw= keyword.split(" ");
					keyword="";
					for(var j=0;j<sp_kw.length-1;j++) keyword+=sp_kw[j]+"+";
					keyword+=sp_kw[sp_kw.length-1];
					page=0;
					getlist(keyword,0);
				
			}

			function getlist(keyword,page){

				$.ajax({
						url: 'getpage.php',
						type: 'post',
						dataType: 'json',
						data: {keyword:keyword,page:page}
					})
					.done(function (data) {
						var page = $('.page').html("");
						console.log(data.length);
						for(var i=0;i<data.length;i++){
							var intext = $('<div>').addClass('inbox').text(data[i].name),
								boxtext = $('<div>').addClass('boxtext').append(intext),
								box = $('<div>').addClass('box').append(boxtext).css('background-image', 'url('+data[i].img+')').attr('link',data[i].href);
							page.append(box);

							box.click(function(event) {
								var link = $(this).attr('link');

								$('.page2').fadeIn('fast');
								$('.bookimg').attr('src', 'img/loading.gif');

								$.ajax({
									url: 'getbook.php',
									type: 'post',
									dataType: 'json',
									data: {link: link}
								})
								.done(function (data) {
									listbookimglink = data;
									bookpage=0;
									getdetailImg(bookpage);
								});
							});
						}
						showcontrol(keyword,page);
					});
			}



			function showcontrol(keyword){

				var backend = $('<span>').text("回頂頁"),
					prev = $('<span>').text("回上頁"),
					next = $('<span>').text("到下頁");

				var all = $('.changepagebar').html("");

				backend.click(function(event) {
					getlist(keyword,0);
				});

				prev.click(function(event) {
					page--;
					getlist(keyword,page);
				});

				next.click(function(event) {
					page++;
					getlist(keyword,page);
				});

				if(page>0){
					all.append(backend).append(prev);
				}
				all.append(next);
			}


			function getdetailImg(page){
				var loading = $('#loading');
				loading.fadeIn('fast');
				$.ajax({
					url: 'getimg.php',
					type: 'post',
					dataType: 'text',
					data: {url: listbookimglink[page]},
				})
				.done(function (data) {
					$('.bookimg').attr('src', data);
					loading.fadeOut('fast');
				});
				
			}



		});

	</script>
</head>
<body>
	
	<br>
	
	<div class="searchbar"><input type="text" id="keyword"><input type="button" id="btn_get" value="搜尋"></div>

	<div class="page"></div>
	<div class="changepagebar"></div>
	<div class="page2">
		
		<div class="colsepages">
			<span id="loading">載入中...........</span>
			<span id="bookbackend">頂頁</span>
			<span id="bookprev">上頁</span>
			<span id="booknext">下頁</span>
			<span id="bookend">最後</span>
			<span id="bookcolose">關閉</span>
		</div>

		<img src="img/loading.gif" class="bookimg">
	</div>
	
	
</body>
</html>